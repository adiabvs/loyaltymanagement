# Building Production APK with React Native CLI

This guide explains how to build a production APK using React Native CLI (not EAS).

## Prerequisites

1. **Node.js** (v18 or higher)
2. **Java JDK** (17 or higher)
3. **Android Studio** with Android SDK
4. **Android SDK** (API level 33+)
5. **Gradle** (comes with Android project)

### Verify Prerequisites

```bash
# Check Node.js
node --version

# Check Java
java -version

# Check Android SDK (set ANDROID_HOME)
echo $ANDROID_HOME  # Linux/Mac
echo %ANDROID_HOME%  # Windows
```

## Quick Build (Recommended)

### Windows:
```bash
cd frontend
npm install
npm run build:apk:windows
```

### Linux/Mac:
```bash
cd frontend
npm install
npm run build:apk
```

### Or use the build scripts:

**Windows:**
```bash
cd frontend
build-apk.bat
```

**Linux/Mac:**
```bash
cd frontend
chmod +x build-apk.sh
./build-apk.sh
```

## Manual Build Steps

### Step 1: Install Dependencies

```bash
cd frontend
npm install
```

### Step 2: Set Production Environment Variables

**Windows (PowerShell):**
```powershell
$env:NODE_ENV="production"
$env:EXPO_PUBLIC_ENV="production"
$env:EXPO_PUBLIC_API_URL="https://loyaltymanagement.onrender.com/api"
```

**Windows (CMD):**
```cmd
set NODE_ENV=production
set EXPO_PUBLIC_ENV=production
set EXPO_PUBLIC_API_URL=https://loyaltymanagement.onrender.com/api
```

**Linux/Mac:**
```bash
export NODE_ENV=production
export EXPO_PUBLIC_ENV=production
export EXPO_PUBLIC_API_URL=https://loyaltymanagement.onrender.com/api
```

### Step 3: Generate Native Android Project

This creates the `android` folder with native code:

```bash
npx expo prebuild --platform android --clean
```

**Note:** The `--clean` flag removes existing android folder and regenerates it.

### Step 4: Build Release APK

```bash
cd android

# Linux/Mac
./gradlew assembleRelease

# Windows
gradlew.bat assembleRelease
```

### Step 5: Find Your APK

The APK will be located at:

```
android/app/build/outputs/apk/release/app-release.apk
```

## Production Configuration

The build uses these production settings:

- **Environment:** `production`
- **API URL:** `https://loyaltymanagement.onrender.com/api`
- **Build Type:** Release APK (optimized, signed)

These are set via environment variables during the build process.

## Installing the APK

### Option 1: Using ADB (Android Debug Bridge)

```bash
adb install android/app/build/outputs/apk/release/app-release.apk
```

### Option 2: Manual Installation

1. Transfer `app-release.apk` to your Android device
2. Enable "Install from Unknown Sources" in device settings
3. Open the APK file on your device
4. Follow installation prompts

## Troubleshooting

### Error: "ANDROID_HOME is not set"

**Windows:**
```cmd
set ANDROID_HOME=C:\Users\YourUsername\AppData\Local\Android\Sdk
set PATH=%PATH%;%ANDROID_HOME%\tools;%ANDROID_HOME%\platform-tools
```

**Linux/Mac:**
```bash
export ANDROID_HOME=$HOME/Android/Sdk
export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
```

Add to `~/.bashrc` or `~/.zshrc` for permanent setup.

### Error: "Gradle build failed"

1. Check Java version (should be 17+):
   ```bash
   java -version
   ```

2. Clean and rebuild:
   ```bash
   cd android
   ./gradlew clean
   ./gradlew assembleRelease
   ```

### Error: "SDK location not found"

Create `android/local.properties`:
```properties
sdk.dir=C\:\\Users\\YourUsername\\AppData\\Local\\Android\\Sdk
```

Or on Linux/Mac:
```properties
sdk.dir=/home/username/Android/Sdk
```

### Error: "Metro bundler not found"

Make sure you're in the `frontend` directory and dependencies are installed:
```bash
npm install
```

### Build is slow

- First build takes longer (downloads dependencies)
- Subsequent builds are faster
- Use `--clean` flag only when needed

## Signing the APK (Optional)

For production distribution, you may want to sign the APK:

1. Generate a keystore:
```bash
keytool -genkeypair -v -storetype PKCS12 -keystore my-release-key.keystore -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000
```

2. Configure signing in `android/app/build.gradle`

3. Build signed APK:
```bash
./gradlew assembleRelease
```

## Build Output

After successful build, you'll see:

```
BUILD SUCCESSFUL in 2m 30s
```

APK location:
- **Path:** `android/app/build/outputs/apk/release/app-release.apk`
- **Size:** ~20-50 MB (depending on assets)
- **Type:** Release APK (optimized, minified)

## Verification

After building, verify the APK:

```bash
# Check APK info
aapt dump badging android/app/build/outputs/apk/release/app-release.apk

# Install and test
adb install android/app/build/outputs/apk/release/app-release.apk
```

## Notes

- The `android` folder is generated by `expo prebuild` and should be added to `.gitignore`
- Production builds are optimized and minified
- The APK uses production API endpoints automatically
- First build may take 5-10 minutes (downloads dependencies)
- Subsequent builds are faster (2-5 minutes)

## Next Steps

1. Test the APK on a physical device
2. Distribute to testers
3. Upload to Google Play Store (if needed)
4. Monitor app performance and errors


